apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "onix-kafka.fullname" . }}-{{ .Values.component }}-config
  labels:
    {{- include "onix-kafka.labels" . | nindent 4 }}
    component: {{ .Values.component }}
data:
  {{- if eq .Values.component "bap" }}
  bapTxnCaller-routing.yaml: |
{{ .Values.config.routing.caller | indent 4 }}
  bapTxnReciever-routing.yaml: |
{{ .Values.config.routing.receiver | indent 4 }}
  {{- else }}
  bppTxnCaller-routing.yaml: |
{{ .Values.config.routing.caller | indent 4 }}
  bppTxnReciever-routing.yaml: |
{{ .Values.config.routing.receiver | indent 4 }}
  {{- end }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "onix-kafka.fullname" . }}-{{ .Values.component }}-adapter
  labels:
    {{- include "onix-kafka.labels" . | nindent 4 }}
    component: {{ .Values.component }}
data:
  adapter.yaml: |
{{- $fullname := include "onix-kafka.fullname" . }}
{{- /* Construct Redis hostname */}}
{{- $redisHost := printf "%s-redis-%s" $fullname .Values.component }}
{{- $redisPort := int .Values.redis.service.port }}
{{- $redisAddr := printf "%s:%d" $redisHost $redisPort }}
{{- $kafkaBroker := .Values.kafka.broker }}
{{- if not $kafkaBroker }}
{{- $kafkaPort := int .Values.kafka.service.port }}
{{- $kafkaBroker = printf "%s-kafka:%d" $fullname $kafkaPort }}
{{- end }}
{{- /* Replace service addresses in adapter config */}}
{{- $adapterConfig := .Values.config.adapter }}
{{- /* Replace Redis addresses */}}
{{- $adapterConfig = $adapterConfig | replace "redis-bap:6379" $redisAddr }}
{{- $adapterConfig = $adapterConfig | replace "redis-bpp:6379" $redisAddr }}
{{- /* Replace Kafka broker */}}
{{- $adapterConfig = $adapterConfig | replace "kafka:9092" $kafkaBroker }}
{{ $adapterConfig | indent 4 }}
